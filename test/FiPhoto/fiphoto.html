<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>FiPhoto</title>
<script src="js/jquery.min.js"></script>
<script src="js/common.js"></script>
<script src="js/glfx.js"></script>
<style>
body,p,ul,ol,h1,h2,h3,h4,h5,h6 {
    margin: 0;
    padding: 0;
}
body {
    background: #f7f7f7;
}
h1 {
    text-align: center;
    background: #f1f1f1;
    border-bottom: 1px solid #e0e0e0;
    padding: 30px;
}
.container {
    margin: 0 auto;
    background: #fff;  
    text-align: center;
    min-height: 300px;
    padding: 60px 0;
}
.container:hover, .container.hover {
    background: #f3f3f3;
}
.container img, canvas {
    border: 1px solid #f3f3f3;
    -webkit-box-shadow:2px 2px 5px #000;
    padding: 10px;
    background: #fff;
}
.hide {
    display: none;
}
.fx-tab {
    padding: 8px;
    background: #9f9f9f;
    border-top: 1px solid #f0f0f0;
    text-align: center;
    display: none;
}
.fx-tab ul {
    display: inline-block;
    list-style: none;
}
.fx-tab li {
    height: 48px;
    width: 48px;
    float: left;
    margin-right: 8px;
    -webkit-border-radius: 5px;
    background: #fff;
    font-size: 10px;
    line-height: 46px;
    cursor: pointer;
}
.fx-tab li:hover {
    background: #edb23c;
}
.fx-tab li.current {
    background: #fa4900;
}
</style>
</head>

<body>
    <h1>FiPhoto</h1>
    <div id="container" class="container">
        click to upload or drag an image here
    </div>

    <div id="fx-tab-container" class="fx-tab"></div>
    <div id="fx-image-wrap" class="hide"></div>
    <script>
        $.NS('FiPhoto', function () {
            var pkg = this;
            
            function generateCanvas(succFunc, errFunc) {
                pkg.$con = $('#container');
                pkg.$imgWrap = $('#fx-image-wrap');
                pkg.$tabWrap = $('#fx-tab-container');
                try {
                    var canvas = fx.canvas();
                    if (!!canvas) {
                        pkg.canvas = canvas;                      
                        succFunc(canvas);
                    }
                    
                } catch(e) {
                    alert(e);
                    !!errFunc && errFunc();
                    return;
                }
            }
            
            function bindEvent() {
                pkg.$con.bind('dragenter', function (e) {
                    e.preventDefault();
                    pkg.$con.addClass('hover');
                }).bind('dragleave', function (e) {
                    e.preventDefault();
                    pkg.$con.removeClass('hover');
                }).bind('dragover', function (e) {
                    e.preventDefault();
                }).bind('drop', function (e) {
                    e.preventDefault();
                    pkg.$con.removeClass('hover');
                    
                    var dt = e.dataTransfer || e.originalEvent.dataTransfer;  
                    var files = dt.files; 
        
                    pkg.handleFiles(files);  
                })
                
            }
            
            function errCallback() {
                pkg.$con.html('Sorry, Your browser do not support webGL')
            }
            
            this.init = function () {
                generateCanvas(bindEvent, errCallback);
                FiPhoto.tab.init();
            };
            this.handleFiles = function (files) {
                for (var i = 0; i < files.length; i++) {  
                    var file = files[i];  
                    var imageType = /image.*/;  
                      
                    if (!file.type.match(imageType)) {  
                      continue;  
                    }  
     
                    var reader = new FileReader();  
                    reader.onload = function(e){ 
                        pkg.setFx('normal', e.target.result);
                    }

                    reader.readAsDataURL(file);  
                }  
            }

            
            this.setFx = function (type, url) {
                var image = document.getElementById('fx-image');
                if (!image) {
                    image = document.createElement('img');
                    image.id = 'fx-image';
                    pkg.$imgWrap.append(image);
                }
                pkg.image = image;
                if (url) {
                    pkg.image.src = url;
                }
                //$(pkg.image).hide();
                FiPhoto.fx[type]();
                FiPhoto.tab.show();
                FiPhoto.tab.update(type);
            }
        });
            
        $.NS('FiPhoto.fx', function () {

            this.normal = function () {
                var canvas = FiPhoto.canvas,
                    image = FiPhoto.image;
                function imgLoadCallback () {
                    var texture = canvas.texture(image);
                    canvas.draw(texture).vignette(0.2, 0.4).update();
                    FiPhoto.$con.empty().append(canvas);
                }
                if (image.complete) {
                    imgLoadCallback();
                    return;
                }
                $(image).load(imgLoadCallback)

            };
            this.amaro = function () {
                var canvas = FiPhoto.canvas,
                    image = FiPhoto.image;
                function imgLoadCallback() {
                    var texture = canvas.texture(image);
                    canvas.draw(texture).brightnessContrast(0, 0.15).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).sepia(0.4).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).vignette(0.2, 0.4).update();
                    FiPhoto.$con.empty().append(canvas);
                }
                if (image.complete) {
                    imgLoadCallback();
                    return;
                }
                $(image).load(imgLoadCallback)

            };
            this.rise = function () {
                var canvas = FiPhoto.canvas,
                    image = FiPhoto.image;
                function imgLoadCallback() {
                    var texture = canvas.texture(image);
                    canvas.draw(texture).brightnessContrast(0.05, 0.3).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).hueSaturation(-0.02, 0.3).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).sepia(0.6).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).vignette(0.12, 0.4).update();
                    FiPhoto.$con.empty().append(canvas);
                }    
                if (image.complete) {
                    imgLoadCallback();
                    return;
                }
                $(image).load(imgLoadCallback)
            };
            this.hudson = function () {
                var canvas = FiPhoto.canvas,
                    image = FiPhoto.image;
                function imgLoadCallback() {
                    var texture = canvas.texture(image);
                    canvas.draw(texture).brightnessContrast(0.15, 0.15).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).hueSaturation(0, 0.15).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).vignette(0.2, 0.5).update();
                    FiPhoto.$con.empty().append(canvas);
                }    
                if (image.complete) {
                    imgLoadCallback();
                    return;
                }
                $(image).load(imgLoadCallback)
            }
            this.xpoll = function () {
                var canvas = FiPhoto.canvas,
                    image = FiPhoto.image;
                function imgLoadCallback() {
                    var texture = canvas.texture(image);
                    canvas.draw(texture).brightnessContrast(0, 0.25).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).hueSaturation(0, 0.2).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).vignette(0, 0.5).update();
                    FiPhoto.$con.empty().append(canvas);
                }    
                if (image.complete) {
                    imgLoadCallback();
                    return;
                }
                $(image).load(imgLoadCallback)
            }
            this.inkwell = function () {
                var canvas = FiPhoto.canvas,
                    image = FiPhoto.image;
                function imgLoadCallback() {
                    var texture = canvas.texture(image);
                    canvas.draw(texture).brightnessContrast(0.05, 0.2).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).hueSaturation(0, -1).update();
                    texture = canvas.texture(canvas);
                    canvas.draw(texture).vignette(0.15, 0.5).update();
                    FiPhoto.$con.empty().append(canvas);
                }    
                if (image.complete) {
                    imgLoadCallback();
                    return;
                }
                $(image).load(imgLoadCallback)
            }
            
        });
            
        $.NS('FiPhoto.tab', function () {
            var pkg = this;
            this.init = function () {
                this.create();
                this.bind();
            };
            this.create = function () {
                var dom = [];
                dom.push('<ul>');
                for (var k in FiPhoto.fx) {
                    dom.push('<li data-cmd="'+ k +'">'+ k +'</li>');
                }
                dom.push('</ul>');
                FiPhoto.$tabWrap.html(dom.join(''));
                
                pkg.$ul = FiPhoto.$tabWrap.find('ul');
                pkg.$li = pkg.$ul.find('li');
                
            };
            this.bind = function () {
                pkg.$li.bind('click', function (e) {
                    e.preventDefault();
                    var cmd = $(this).attr('data-cmd');
                    FiPhoto.setFx(cmd);
                })
            };
            this.show = function () {
                FiPhoto.$tabWrap.slideDown();
            };
            this.update = function (type) {
                pkg.$li.removeClass('current');
                pkg.$li.each(function (i) {
                    if ($(this).attr('data-cmd') == type) {
                        $(this).addClass('current');
                        return;
                    }
                })
            }
        })
            
 
        $(function () { FiPhoto.init(); });
    </script>
</body>
</html>