<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>FiPhoto</title>
<script src="http://code.jquery.com/jquery.min.js"></script>
<script src="js/common.js"></script>
<script src="js/glfx.js"></script>
<style>
body,p,ul,ol,h1,h2,h3,h4,h5,h6 {
    margin: 0;
    padding: 0;
}
body {
    background: #f7f7f7;
}
h1 {
    text-align: center;
    background: #f1f1f1;
    border-bottom: 1px solid #e0e0e0;
    padding: 30px;
}
.container {
    margin: 0 auto;
    background: #fff;  
    text-align: center;
    min-height: 300px;
    padding: 60px 0;
}
.container:hover, .container.hover {
    background: #f3f3f3;
}
.container img, canvas {
    border: 1px solid #f3f3f3;
    -webkit-box-shadow:2px 2px 5px #000;
    padding: 10px;
    background: #fff;
}
</style>
</head>

<body>
    <h1>FiPhoto</h1>
    <div id="container" class="container">
        click to upload or drag an image here
    </div>
    
    <script>
        $(function () {
            var $con = $('#container');
            var canvas;
            
            var imgFX = {
                normal: function (image) {
                    image.onload = function (e) {
                        var texture = canvas.texture(image);
                        canvas.draw(texture).vignette(0.5, 0.5).update();
                        image.parentNode.insertBefore(canvas, image);
                        image.parentNode.removeChild(image);  
                    }
                },
                amaro: function (image) {
                    image.onload = function (e) {
                        var texture = canvas.texture(image);
                        canvas.draw(texture).brightnessContrast(0, 0.15).update();
                        texture = canvas.texture(canvas);
                        canvas.draw(texture).sepia(0.4).update();
                        texture = canvas.texture(canvas);
                        canvas.draw(texture).vignette(0.5, 0.5).update();
                        image.parentNode.insertBefore(canvas, image);
                        image.parentNode.removeChild(image);  
                    }
                }
            };
            
            var FXtab = function () {
                var tpl;
                
                return {
                    init: function () {
                        
                    }
                };
            }();
            
            // private methods
            function generateCanvas(succFunc, errFunc) {
                try {
                    canvas = fx.canvas();
                    !!canvas && succFunc(canvas);
                } catch(e) {
                    alert(e);
                    !!errFunc && errFunc();
                }
            }
            
            function displayImage(container,dataURL){
                var imgStr = '<img id="fx-image" alt="" src="'+ dataURL +'" />';
                $con.html(imgStr);
                
                imageFx();
            }
            
            function imageFx() {

                // convert the image to a texture
                var image = document.getElementById('fx-image');
                imgFX.amaro(image);
                
            }
            function handleFiles(files){
                for (var i = 0; i < files.length; i++) {  
                    var file = files[i];  
                    var imageType = /image.*/;  
                      
                    if (!file.type.match(imageType)) {  
                      continue;  
                    }  
     
                    var reader = new FileReader();  
                    reader.onload = function(e){ 

                        displayImage($con.get(0), e.target.result);
                    }

                    reader.readAsDataURL(file);  
                }  
            }
            
            function bindEvent() {
                $con.bind('dragenter', function (e) {
                    e.preventDefault();
                    $con.addClass('hover');
                }).bind('dragleave', function (e) {
                    e.preventDefault();
                    $con.removeClass('hover');
                }).bind('dragover', function (e) {
                    e.preventDefault();
                }).bind('drop', function (e) {
                    e.preventDefault();
                    $con.removeClass('hover');
                    
                    var dt = e.dataTransfer || e.originalEvent.dataTransfer;  
                    var files = dt.files; 
        
                    handleFiles(files);  
                })
                
            }
            
            function errCallback() {
                $con.html('Sorry, Your browser do not support webGL')
            }
            
            // activate
            generateCanvas(bindEvent, errCallback);           
            
        })
    </script>
</body>
</html>